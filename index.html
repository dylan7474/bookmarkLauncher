<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Launchpad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#030712',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #f8fafc; /* Slate 50 */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            transition: background-image 0.3s ease;
        }

        /* Dark overlay to keep buttons and text readable over custom backgrounds */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(15, 23, 42, 0.7); /* Slate 900 with opacity */
            z-index: -1;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        body.has-bg::before {
            opacity: 1;
        }
        
        .bookmark-btn {
            transition: all 0.2s ease;
        }
        
        .bookmark-btn:hover {
            transform: translateY(-2px);
        }
        
        .edit-mode-active .bookmark-btn {
            animation: pulse-border 2s infinite;
            cursor: grab;
        }

        .edit-mode-active .bookmark-btn:active {
            cursor: grabbing;
        }

        .edit-mode-active .bookmark-btn:hover {
            border-color: #3b82f6;
            background-color: rgba(59, 130, 246, 0.1);
        }

        .bookmark-btn.drag-over {
            border-color: #3b82f6 !important;
            background-color: rgba(59, 130, 246, 0.2) !important;
            transform: scale(1.05);
            z-index: 10;
        }

        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 4px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }

        /* Modal backdrop */
        dialog::backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }
        
        /* Hide scrollbar for cleaner look but keep functionality */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: transparent; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }
    </style>
</head>
<body class="min-h-screen flex flex-col selection:bg-blue-500/30">

    <!-- Header Navigation -->
    <header class="sticky top-0 z-10 backdrop-blur-md bg-slate-900/80 border-b border-slate-800 px-6 py-4 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center shadow-lg shadow-blue-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            </div>
            <h1 class="text-xl font-bold tracking-tight">Launchpad</h1>
        </div>
        
        <div class="flex items-center gap-3">
            <button id="toggleEditBtn" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white border border-slate-700">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                <span id="editText">Edit Mode</span>
            </button>
            <div class="w-px h-6 bg-slate-700 mx-1"></div>
            
            <!-- Config Export/Import -->
            <button id="exportBtn" class="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors tooltip-trigger" title="Export Config">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
            </button>
            <label class="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors cursor-pointer tooltip-trigger" title="Import Config">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                <input type="file" id="importFile" class="hidden" accept=".json" />
            </label>

            <div class="w-px h-6 bg-slate-700 mx-1"></div>
            
            <!-- Background Controls -->
            <label class="p-2 rounded-lg text-slate-400 hover:text-white hover:bg-slate-800 transition-colors cursor-pointer tooltip-trigger" title="Set Background Image">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                <input type="file" id="bgInput" class="hidden" accept="image/*" />
            </label>
            <button id="bgClearBtn" class="p-2 rounded-lg text-slate-400 hover:text-red-400 hover:bg-slate-800 transition-colors hidden tooltip-trigger" title="Clear Background">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3l18 18"/><path d="M15 9l-6 6"/><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/></svg>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main id="mainContainer" class="flex-1 flex flex-col p-6 max-w-6xl mx-auto w-full gap-8">
        
        <!-- Edit Mode Banner -->
        <div id="editBanner" class="hidden bg-blue-500/20 border border-blue-500/50 text-blue-200 px-4 py-3 rounded-lg flex items-center justify-between">
            <div class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
                <span><strong>Edit Mode Active.</strong> Drag to reorder, or click any tile to edit its destination.</span>
            </div>
            <button id="doneEditingBtn" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-md transition-colors">Done</button>
        </div>

        <!-- Upper Half: 8 Large Buttons -->
        <section class="flex-1 min-h-[40vh] flex flex-col justify-center">
            <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4 px-2 drop-shadow-md">Primary Sites</h2>
            <div id="primaryGrid" class="grid grid-cols-2 sm:grid-cols-4 gap-4 md:gap-6">
                <!-- Rendered via JS -->
            </div>
        </section>

        <!-- Divider -->
        <div class="flex items-center gap-4 opacity-50">
            <div class="h-px bg-gradient-to-r from-transparent via-slate-600 to-transparent flex-1"></div>
        </div>

        <!-- Lower Half: 16 Smaller Buttons -->
        <section class="flex-1 min-h-[40vh] flex flex-col justify-start pb-8">
            <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-4 px-2 drop-shadow-md">Secondary Sites</h2>
            <div id="secondaryGrid" class="grid grid-cols-4 sm:grid-cols-8 gap-3 md:gap-4">
                <!-- Rendered via JS -->
            </div>
        </section>

    </main>

    <!-- Edit Modal -->
    <dialog id="editModal" class="bg-slate-900 border border-slate-700 rounded-xl shadow-2xl p-0 w-full max-w-md text-slate-200 m-auto">
        <div class="px-6 py-4 border-b border-slate-800 flex justify-between items-center">
            <h3 class="text-lg font-semibold" id="modalTitle">Edit Bookmark</h3>
            <button id="closeModalBtn" class="text-slate-400 hover:text-white transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
            </button>
        </div>
        <form id="editForm" class="p-6">
            <input type="hidden" id="editType">
            <input type="hidden" id="editIndex">
            
            <div class="mb-4">
                <label for="siteName" class="block text-sm font-medium text-slate-400 mb-1">Website Name</label>
                <input type="text" id="siteName" required class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-slate-500" placeholder="e.g. GitHub">
            </div>
            
            <div class="mb-6">
                <label for="siteUrl" class="block text-sm font-medium text-slate-400 mb-1">URL</label>
                <input type="url" id="siteUrl" required class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent placeholder-slate-500" placeholder="https://example.com">
                <p class="text-xs text-slate-500 mt-2">The icon will be fetched automatically based on the URL.</p>
            </div>
            
            <div class="mb-6 border-t border-slate-800 pt-4">
                <label class="block text-sm font-medium text-slate-400 mb-2">Custom Icon (Optional)</label>
                <div class="flex items-center gap-4">
                    <div id="iconPreview" class="w-12 h-12 rounded-lg bg-slate-800 border border-slate-700 flex items-center justify-center overflow-hidden p-1 shrink-0">
                        <span class="text-xs text-slate-500">None</span>
                    </div>
                    <div class="flex-1 overflow-hidden">
                        <input type="file" id="siteIconInput" accept="image/*" class="w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-slate-800 file:text-white hover:file:bg-slate-700 file:cursor-pointer transition-colors border border-slate-700 rounded-lg p-1 bg-slate-900">
                        <p class="text-xs text-slate-500 mt-2">Overrides the default icon. Images are automatically compressed to keep your config file small.</p>
                    </div>
                </div>
            </div>
            
            <div class="flex justify-between items-center">
                <button type="button" id="clearBtn" class="text-sm text-red-400 hover:text-red-300 transition-colors px-2 py-1">Clear Link</button>
                <div class="flex gap-3">
                    <button type="button" id="cancelModalBtn" class="px-4 py-2 text-sm font-medium text-slate-300 bg-slate-800 border border-slate-700 rounded-lg hover:bg-slate-700 transition-colors">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors shadow-lg shadow-blue-500/20">Save Changes</button>
                </div>
            </div>
        </form>
    </dialog>

    <!-- Message Toast -->
    <div id="toast" class="fixed bottom-6 right-6 transform translate-y-20 opacity-0 transition-all duration-300 bg-slate-800 border border-slate-700 text-white px-4 py-3 rounded-lg shadow-xl flex items-center gap-3 z-50 pointer-events-none">
        <svg id="toastIcon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        <span id="toastMsg" class="text-sm font-medium">Message</span>
    </div>

    <script>
        // Default configuration
        const DEFAULT_CONFIG = {
            backgroundImage: null,
            primary: Array.from({ length: 8 }, (_, i) => ({ title: "", url: "", icon: null })),
            secondary: Array.from({ length: 16 }, (_, i) => ({ title: "", url: "", icon: null }))
        };

        // Populate with some sensible defaults for first-time users
        const INITIAL_DEFAULTS = {
            backgroundImage: null,
            primary: [
                { title: "Google", url: "https://google.com", icon: null },
                { title: "YouTube", url: "https://youtube.com", icon: null },
                { title: "GitHub", url: "https://github.com", icon: null },
                { title: "Reddit", url: "https://reddit.com", icon: null },
                { title: "Gmail", url: "https://mail.google.com", icon: null },
                { title: "ChatGPT", url: "https://chatgpt.com", icon: null },
                { title: "Twitter/X", url: "https://x.com", icon: null },
                { title: "Netflix", url: "https://netflix.com", icon: null }
            ],
            secondary: Array.from({ length: 16 }, (_, i) => ({ title: "", url: "", icon: null }))
        };

        // App State
        let state = {
            config: null,
            isEditMode: false
        };
        let tempIconBase64 = null;
        let dragSource = null;

        // DOM Elements
        const primaryGrid = document.getElementById('primaryGrid');
        const secondaryGrid = document.getElementById('secondaryGrid');
        const mainContainer = document.getElementById('mainContainer');
        const toggleEditBtn = document.getElementById('toggleEditBtn');
        const doneEditingBtn = document.getElementById('doneEditingBtn');
        const editText = document.getElementById('editText');
        const editBanner = document.getElementById('editBanner');
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        const clearBtn = document.getElementById('clearBtn');
        const exportBtn = document.getElementById('exportBtn');
        const importFile = document.getElementById('importFile');
        const bgInput = document.getElementById('bgInput');
        const bgClearBtn = document.getElementById('bgClearBtn');
        const siteIconInput = document.getElementById('siteIconInput');
        const iconPreview = document.getElementById('iconPreview');
        const toast = document.getElementById('toast');
        const toastMsg = document.getElementById('toastMsg');

        // Initialize App
        function init() {
            loadConfig();
            applyBackground();
            renderGrid();
            setupEventListeners();
        }

        // Data Management
        function loadConfig() {
            const saved = localStorage.getItem('launchpad_config');
            if (saved) {
                try {
                    state.config = JSON.parse(saved);
                    // Ensure structure integrity in case of older versions
                    if(!state.config.primary || state.config.primary.length !== 8) {
                        state.config.primary = DEFAULT_CONFIG.primary;
                    }
                    if(!state.config.secondary || state.config.secondary.length !== 16) {
                        state.config.secondary = DEFAULT_CONFIG.secondary;
                    }
                } catch (e) {
                    state.config = JSON.parse(JSON.stringify(INITIAL_DEFAULTS));
                }
            } else {
                state.config = JSON.parse(JSON.stringify(INITIAL_DEFAULTS));
                saveConfig();
            }
        }

        function saveConfig() {
            localStorage.setItem('launchpad_config', JSON.stringify(state.config));
        }

        // Rendering Visuals
        function applyBackground() {
            if (state.config.backgroundImage) {
                document.body.style.backgroundImage = `url(${state.config.backgroundImage})`;
                document.body.classList.add('has-bg');
                bgClearBtn.classList.remove('hidden');
            } else {
                document.body.style.backgroundImage = 'none';
                document.body.classList.remove('has-bg');
                bgClearBtn.classList.add('hidden');
            }
        }

        function getFaviconUrl(url) {
            if (!url) return '';
            try {
                const domain = new URL(url).hostname;
                return `https://www.google.com/s2/favicons?domain=${domain}&sz=128`;
            } catch (e) {
                return '';
            }
        }

        function getInitials(title) {
            return title ? title.substring(0, 2).toUpperCase() : '+';
        }

        function createButtonHTML(item, type, index) {
            const isPrimary = type === 'primary';
            const hasData = item.url && item.url.trim() !== "";
            const iconUrl = item.icon || getFaviconUrl(item.url);
            
            // Layout differences based on primary (large) vs secondary (small)
            const heightClass = isPrimary ? "h-32 sm:h-36" : "h-20 sm:h-24";
            const iconSize = isPrimary ? "w-14 h-14" : "w-8 h-8";
            const textSize = isPrimary ? "text-base" : "text-xs";
            const gap = isPrimary ? "gap-4" : "gap-2";

            let iconHtml = '';
            if (hasData) {
                iconHtml = `
                    <div class="${iconSize} rounded-xl bg-slate-700/50 flex items-center justify-center overflow-hidden shadow-inner p-1 pointer-events-none">
                        <img src="${iconUrl}" alt="${item.title}" class="w-full h-full object-contain drop-shadow-md rounded-lg" 
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
                        <div class="w-full h-full flex items-center justify-center font-bold text-slate-300 hidden text-xl bg-slate-700">
                            ${getInitials(item.title)}
                        </div>
                    </div>`;
            } else {
                iconHtml = `
                    <div class="${iconSize} rounded-xl border-2 border-dashed border-slate-700 flex items-center justify-center text-slate-600 transition-colors group-hover:border-slate-500 group-hover:text-slate-400 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" width="${isPrimary ? '24' : '16'}" height="${isPrimary ? '24' : '16'}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    </div>`;
            }

            return `
                <div class="bookmark-btn group relative w-full ${heightClass} bg-slate-800/80 hover:bg-slate-700/90 border border-slate-700/80 rounded-2xl flex flex-col items-center justify-center ${gap} p-4 shadow-sm backdrop-blur-sm"
                     data-type="${type}" data-index="${index}" ${state.isEditMode ? 'draggable="true"' : ''}>
                    ${iconHtml}
                    <span class="${textSize} font-medium text-slate-300 truncate w-full text-center group-hover:text-white transition-colors pointer-events-none drop-shadow-md">
                        ${hasData ? item.title : (state.isEditMode ? 'Empty slot' : '')}
                    </span>
                    ${state.isEditMode ? `
                        <div class="absolute top-2 right-2 p-1.5 bg-blue-500/90 rounded-md text-white opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function renderGrid() {
            primaryGrid.innerHTML = state.config.primary.map((item, i) => createButtonHTML(item, 'primary', i)).join('');
            secondaryGrid.innerHTML = state.config.secondary.map((item, i) => createButtonHTML(item, 'secondary', i)).join('');
            
            // Re-attach event listeners to new elements
            document.querySelectorAll('.bookmark-btn').forEach(btn => {
                btn.addEventListener('click', handleBookmarkClick);
            });
        }

        function toggleEditMode() {
            state.isEditMode = !state.isEditMode;
            
            if (state.isEditMode) {
                mainContainer.classList.add('edit-mode-active');
                editBanner.classList.remove('hidden');
                editText.textContent = 'Done Editing';
                toggleEditBtn.classList.replace('bg-slate-800', 'bg-blue-600/20');
                toggleEditBtn.classList.replace('text-slate-300', 'text-blue-400');
                toggleEditBtn.classList.replace('border-slate-700', 'border-blue-500/50');
            } else {
                mainContainer.classList.remove('edit-mode-active');
                editBanner.classList.add('hidden');
                editText.textContent = 'Edit Mode';
                toggleEditBtn.classList.replace('bg-blue-600/20', 'bg-slate-800');
                toggleEditBtn.classList.replace('text-blue-400', 'text-slate-300');
                toggleEditBtn.classList.replace('border-blue-500/50', 'border-slate-700');
            }
            
            renderGrid(); // Re-render to show/hide edit icons and borders
        }

        // Drag and Drop Logic
        function handleDragStart(e) {
            if (!state.isEditMode) return;
            const btn = e.target.closest('.bookmark-btn');
            if (!btn) return;

            dragSource = {
                type: btn.dataset.type,
                index: parseInt(btn.dataset.index)
            };
            
            e.dataTransfer.effectAllowed = 'move';
            // Slight delay allows the drag ghost image to be full opacity
            setTimeout(() => btn.classList.add('opacity-40'), 0);
        }

        function handleDragOver(e) {
            if (!state.isEditMode) return;
            e.preventDefault(); // Necessary to allow dropping
            
            const btn = e.target.closest('.bookmark-btn');
            if (btn && dragSource && (dragSource.type !== btn.dataset.type || dragSource.index !== parseInt(btn.dataset.index))) {
                btn.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (!state.isEditMode) return;
            const btn = e.target.closest('.bookmark-btn');
            if (btn) {
                btn.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            if (!state.isEditMode) return;
            e.preventDefault();
            
            const btn = e.target.closest('.bookmark-btn');
            if (!btn || !dragSource) return;

            btn.classList.remove('drag-over');

            const targetType = btn.dataset.type;
            const targetIndex = parseInt(btn.dataset.index);

            // Swap the items in the configuration
            if (dragSource.type !== null && dragSource.index !== null &&
               (dragSource.type !== targetType || dragSource.index !== targetIndex)) {
                
                const temp = state.config[targetType][targetIndex];
                state.config[targetType][targetIndex] = state.config[dragSource.type][dragSource.index];
                state.config[dragSource.type][dragSource.index] = temp;

                saveConfig();
                renderGrid();
            }
        }

        function handleDragEnd(e) {
            if (!state.isEditMode) return;
            const btn = e.target.closest('.bookmark-btn');
            if (btn) btn.classList.remove('opacity-40');
            dragSource = null;
            
            document.querySelectorAll('.bookmark-btn').forEach(b => {
                b.classList.remove('drag-over');
            });
        }

        // Interaction Handlers
        function handleBookmarkClick(e) {
            const btn = e.currentTarget;
            const type = btn.dataset.type;
            const index = parseInt(btn.dataset.index);
            const item = state.config[type][index];

            if (state.isEditMode) {
                openEditModal(type, index, item);
            } else {
                if (item.url) {
                    // Make sure URL has protocol
                    let finalUrl = item.url;
                    if (!/^https?:\/\//i.test(finalUrl)) {
                        finalUrl = 'https://' + finalUrl;
                    }
                    window.open(finalUrl, '_blank');
                } else {
                    // If clicking empty slot in normal mode, prompt to edit
                    openEditModal(type, index, item);
                }
            }
        }

        // Modal Logic
        function openEditModal(type, index, item) {
            document.getElementById('editType').value = type;
            document.getElementById('editIndex').value = index;
            document.getElementById('siteName').value = item.title || '';
            document.getElementById('siteUrl').value = item.url || '';
            
            tempIconBase64 = item.icon || null;
            updateIconPreview();
            
            if (item.url) {
                clearBtn.style.display = 'block';
            } else {
                clearBtn.style.display = 'none';
            }

            editModal.showModal();
            document.getElementById('siteName').focus();
        }

        function closeEditModal() {
            editModal.close();
            editForm.reset();
            tempIconBase64 = null;
            updateIconPreview();
        }

        function updateIconPreview() {
            if (!iconPreview) return;
            const url = document.getElementById('siteUrl').value;
            const src = tempIconBase64 || getFaviconUrl(url) || '';
            if (src) {
                iconPreview.innerHTML = `<img src="${src}" class="w-full h-full object-contain drop-shadow-sm rounded" />`;
            } else {
                iconPreview.innerHTML = `<span class="text-xs text-slate-500">None</span>`;
            }
        }

        function handleSaveBookmark(e) {
            e.preventDefault();
            const type = document.getElementById('editType').value;
            const index = parseInt(document.getElementById('editIndex').value);
            const title = document.getElementById('siteName').value.trim();
            let url = document.getElementById('siteUrl').value.trim();

            if (url && !/^https?:\/\//i.test(url)) {
                url = 'https://' + url;
            }

            state.config[type][index] = { title, url, icon: tempIconBase64 };
            
            saveConfig();
            renderGrid();
            closeEditModal();
            showToast('Bookmark saved successfully');
        }

        function handleClearBookmark() {
            const type = document.getElementById('editType').value;
            const index = parseInt(document.getElementById('editIndex').value);
            
            state.config[type][index] = { title: "", url: "", icon: null };
            
            saveConfig();
            renderGrid();
            closeEditModal();
            showToast('Bookmark cleared');
        }

        // Import/Export Logic
        function exportConfig() {
            const dataStr = JSON.stringify(state.config, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `launchpad_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Configuration exported');
        }

        function importConfig(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importedConfig = JSON.parse(event.target.result);
                    
                    // Basic validation
                    if (importedConfig.primary && Array.isArray(importedConfig.primary) && importedConfig.primary.length === 8 &&
                        importedConfig.secondary && Array.isArray(importedConfig.secondary) && importedConfig.secondary.length === 16) {
                        
                        state.config = importedConfig;
                        saveConfig();
                        applyBackground();
                        renderGrid();
                        showToast('Configuration imported successfully');
                    } else {
                        throw new Error("Invalid format");
                    }
                } catch (err) {
                    showToast('Error: Invalid JSON configuration file', true);
                }
                
                // Reset file input
                importFile.value = '';
            };
            reader.readAsText(file);
        }

        // UI Helpers
        function showToast(message, isError = false) {
            toastMsg.textContent = message;
            const iconPath = isError 
                ? '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>' 
                : '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>';
            
            document.getElementById('toastIcon').innerHTML = iconPath;
            document.getElementById('toastIcon').className = isError ? 'text-red-400' : 'text-green-400';
            
            toast.classList.remove('translate-y-20', 'opacity-0');
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        function setupEventListeners() {
            toggleEditBtn.addEventListener('click', toggleEditMode);
            doneEditingBtn.addEventListener('click', toggleEditMode);
            
            closeModalBtn.addEventListener('click', closeEditModal);
            cancelModalBtn.addEventListener('click', closeEditModal);
            editForm.addEventListener('submit', handleSaveBookmark);
            clearBtn.addEventListener('click', handleClearBookmark);
            
            // Drag and Drop Listeners attached to the main container
            mainContainer.addEventListener('dragstart', handleDragStart);
            mainContainer.addEventListener('dragover', handleDragOver);
            mainContainer.addEventListener('dragleave', handleDragLeave);
            mainContainer.addEventListener('drop', handleDrop);
            mainContainer.addEventListener('dragend', handleDragEnd);
            
            // Background Selection Handlers
            bgInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const MAX_SIZE = 1920; // Ensure BG fits in json cleanly
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height *= MAX_SIZE / width;
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width *= MAX_SIZE / height;
                                height = MAX_SIZE;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Compression (webp at 0.7 quality saves significant storage space)
                        state.config.backgroundImage = canvas.toDataURL('image/webp', 0.7);
                        saveConfig();
                        applyBackground();
                        showToast('Background updated');
                        bgInput.value = ''; // Reset input
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });

            bgClearBtn.addEventListener('click', () => {
                state.config.backgroundImage = null;
                saveConfig();
                applyBackground();
                showToast('Background cleared');
            });

            // Update preview continuously if user alters URL
            document.getElementById('siteUrl').addEventListener('input', updateIconPreview);

            // Handle custom image uploads
            siteIconInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        // Create offscreen canvas to resize image
                        const canvas = document.createElement('canvas');
                        const MAX_SIZE = 128; // Ensures the exported config doesn't get massive
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height *= MAX_SIZE / width;
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width *= MAX_SIZE / height;
                                height = MAX_SIZE;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Save image downscaled as a WebP
                        tempIconBase64 = canvas.toDataURL('image/webp', 0.8);
                        updateIconPreview();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
            
            // Close modal on outside click
            editModal.addEventListener('click', (e) => {
                const dialogDimensions = editModal.getBoundingClientRect()
                if (
                    e.clientX < dialogDimensions.left ||
                    e.clientX > dialogDimensions.right ||
                    e.clientY < dialogDimensions.top ||
                    e.clientY > dialogDimensions.bottom
                ) {
                    closeEditModal();
                }
            });

            exportBtn.addEventListener('click', exportConfig);
            importFile.addEventListener('change', importConfig);
        }

        // Boot
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
